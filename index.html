<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interior POV Pro v3.1 - 兄 day 專屬工具</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#f1f5f9]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;
        
        // 模擬 Lucide React 組件 (因為 CDN 載入方式不同)
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                    iconRef.current.innerHTML = lucide.createIcons({
                        icons: { [name]: lucide.icons[name] },
                        attrs: { strokeWidth: 2, width: size, height: size }
                    });
                }
            }, [name, size]);
            return <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`}></span>;
        };

        const STYLES = [
            { id: 'modern', name: '現代極簡 (Modern)', prompt: 'Modern luxury interior, marble textures, recessed lighting, neutral tones, high-end furniture.' },
            { id: 'muji', name: '無印風 (Muji)', prompt: 'Japanese minimalist style, light oak wood, white walls, clean lines, natural soft lighting.' },
            { id: 'retro', name: '台式復古 (Retro)', prompt: 'Retro Taiwanese style, terrazzo flooring, floral sofa, warm wooden furniture, 1980s aesthetic.' },
            { id: 'industrial', name: '工業風 (Industrial)', prompt: 'Industrial loft style, exposed brick walls, dark metal accents, leather furniture, concrete flooring.' },
            { id: 'custom', name: '✨ 自定義風格 (Custom)', prompt: '' }
        ];

        const ROOMS = ["客廳 (Living Room)", "廚房 (Kitchen)", "主臥 (Master Bedroom)", "餐廳 (Dining Room)", "玄關 (Entrance)", "衛浴 (Bathroom)", "自定義空間 (Custom)"];

        const FOCAL_LENGTHS = [
            { label: "14mm", value: "14mm ultra-wide lens", fov: 114 },
            { label: "24mm", value: "24mm wide angle lens", fov: 84 },
            { label: "35mm", value: "35mm standard lens", fov: 63 },
            { label: "50mm", value: "50mm prime lens", fov: 46 }
        ];

        const CAM_HEIGHTS = [
            { label: "160cm (人眼)", value: "160cm (eye level)" },
            { label: "100cm (腰部)", value: "100cm (waist level, magazine style)" },
            { label: "30cm (低角)", value: "30cm (low angle)" }
        ];

        const App = () => {
            const [image, setImage] = useState(null);
            const [arrow, setArrow] = useState(null);
            const [anchor, setAnchor] = useState(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [editMode, setEditMode] = useState("POV"); 
            const [selectedStyle, setSelectedStyle] = useState(STYLES[0]);
            const [styleLocked, setStyleLocked] = useState(false);
            const [selectedRoom, setSelectedRoom] = useState(ROOMS[0]);
            const [mapType, setMapType] = useState("3D"); 
            const [taskType, setTaskType] = useState("POV");
            const [customStylePrompt, setCustomStylePrompt] = useState("");
            const [customRoomName, setCustomRoomName] = useState("");
            const [focalLength, setFocalLength] = useState(FOCAL_LENGTHS[1]);
            const [camHeight, setCamHeight] = useState(CAM_HEIGHTS[1]);
            const [prompt, setPrompt] = useState("");
            const [copied, setCopied] = useState(false);
            const interactionRef = useRef(null);
            const fileInputRef = useRef(null);

            const clearMarkers = useCallback(() => { setArrow(null); setAnchor(null); }, []);

            const handleCanvasInteraction = (e) => {
                if (!image || taskType === "TOPDOWN") return;
                const rect = interactionRef.current.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                if (editMode === "ANCHOR") { setAnchor({ x, y }); setEditMode("POV"); } 
                else { setArrow({ start: { x, y }, end: { x, y } }); setIsDrawing(true); }
            };

            const handleMouseMove = (e) => {
                if (!isDrawing || !interactionRef.current) return;
                const rect = interactionRef.current.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                setArrow(prev => prev ? { ...prev, end: { x, y } } : null);
            };

            const updatePrompt = useCallback(() => {
                const finalStyle = selectedStyle.id === 'custom' ? customStylePrompt : selectedStyle.prompt;
                const finalRoom = selectedRoom === '自定義空間 (Custom)' ? customRoomName : selectedRoom;
                if (taskType === "TOPDOWN") {
                    setPrompt(`[TASK: 3D TOP-DOWN VIEW]\nTransform this 2D floor plan into a professional 3D top-down perspective visualization. \nOrientation: North is at the top of the image.\nSpace Type: ${finalRoom || "Interior Space"}\nStyle: ${finalStyle || "High-quality architectural style"}\nVisuals: Realistic wall thickness, exact furniture placement.\nQuality: 8k resolution, photorealistic.`);
                    return;
                }
                if (!arrow) { setPrompt("請標註相機 POV..."); return; }
                const dx = arrow.end.x - arrow.start.x;
                const dy = arrow.end.y - arrow.start.y;
                const angleDeg = Math.atan2(dy, dx) * (180 / Math.PI);
                let leftSide = "Left", rightSide = "Right";
                if (angleDeg > -45 && angleDeg <= 45) { leftSide = "North (Top)"; rightSide = "South (Bottom)"; }
                else if (angleDeg > 45 && angleDeg <= 135) { leftSide = "East (Right)"; rightSide = "West (Left)"; }
                else if (angleDeg > 135 || angleDeg <= -135) { leftSide = "South (Bottom)"; rightSide = "North (Top)"; }
                else { leftSide = "West (Left)"; rightSide = "East (Right)"; }
                const anchorNote = anchor ? `[VISUAL FOCUS]: Object at map coordinate (${Math.round(anchor.x)}%, ${Math.round(anchor.y)}%).` : "";
                setPrompt(`[TASK: INTERIOR PERSPECTIVE]\nGenerate photo of a ${finalRoom || "area"}.\nOrientation: N=Up, E=Right, S=Down, W=Left.\n[CAMERA]: Coordinate (${Math.round(arrow.start.x)}%, ${Math.round(arrow.start.y)}%), Lens ${focalLength.value}, Height ${camHeight.value}, Facing ${Math.round(angleDeg)}°.\n[PHYSICAL ALIGNMENT]: \n- The ${leftSide} must appear on the LEFT.\n- The ${rightSide} must appear on the RIGHT.\n${anchorNote}\n[STYLE]: ${finalStyle || "Professional"}\nVisuals: 8k photorealistic.`);
            }, [arrow, anchor, selectedStyle, customStylePrompt, selectedRoom, customRoomName, taskType, focalLength, camHeight]);

            useEffect(() => { updatePrompt(); }, [updatePrompt]);

            const copyToClipboard = () => {
                const el = document.createElement('textarea'); el.value = prompt; document.body.appendChild(el); el.select();
                try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch(e) {}
                document.body.removeChild(el);
            };

            const getViewConePath = () => {
                if (!arrow) return null;
                const centerAngle = Math.atan2(arrow.end.y - arrow.start.y, arrow.end.x - arrow.start.x);
                const halfFov = (focalLength.fov / 2) * (Math.PI / 180);
                const r = 18;
                const x1 = arrow.start.x + r * Math.cos(centerAngle - halfFov);
                const y1 = arrow.start.y + r * Math.sin(centerAngle - halfFov);
                const x2 = arrow.start.x + r * Math.cos(centerAngle + halfFov);
                const y2 = arrow.start.y + r * Math.sin(centerAngle + halfFov);
                return `M ${arrow.start.x} ${arrow.start.y} L ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2} Z`;
            };

            return (
                <div className="min-h-screen p-4 md:p-6">
                    <div className="max-w-[1550px] mx-auto">
                        <header className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="bg-slate-900 p-3 rounded-2xl text-white shadow-xl shadow-slate-200">
                                    <Icon name="Compass" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black text-slate-900 italic">Interior POV Pro <span className="text-sm font-bold bg-indigo-600 text-white px-3 py-1 rounded-full ml-2 uppercase">v3.1 Final</span></h1>
                                    <p className="text-sm text-slate-500">兄 day：GitHub 穩定版 — 實體對位與自定義空間系統</p>
                                </div>
                            </div>
                            <button onClick={() => fileInputRef.current.click()} className="bg-white border-2 border-slate-200 hover:border-slate-900 px-8 py-3 rounded-2xl font-black text-sm transition-all flex items-center gap-2">
                                <Icon name="Upload" size={18} /> 上傳底圖
                            </button>
                            <input type="file" ref={fileInputRef} onChange={(e) => {
                                const file = e.target.files[0];
                                if (file) {
                                    const reader = new FileReader();
                                    reader.onload = (event) => { setImage(event.target.result); clearMarkers(); };
                                    reader.readAsDataURL(file);
                                }
                            }} className="hidden" accept="image/*" />
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className="lg:col-span-3 space-y-4">
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 space-y-6">
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block text-center">Step 1: 定義任務</label>
                                        <div className="grid grid-cols-2 gap-3 p-1.5 bg-slate-100 rounded-2xl">
                                            <button onClick={() => {setTaskType("TOPDOWN"); clearMarkers();}} className={`py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 ${taskType === "TOPDOWN" ? "bg-slate-900 text-white shadow-lg" : "text-slate-500"}`}><Icon name="Box" size={16}/> 生俯瞰</button>
                                            <button onClick={() => setTaskType("POV")} className={`py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 ${taskType === "POV" ? "bg-slate-900 text-white shadow-lg" : "text-slate-500"}`}><Icon name="Camera" size={16}/> 生透視</button>
                                        </div>
                                    </div>

                                    <div className={`p-4 rounded-2xl border-2 transition-all ${styleLocked ? "bg-slate-900 text-white border-slate-900" : "bg-white border-indigo-100"}`}>
                                        <div className="flex items-center justify-between mb-3">
                                            <label className="text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
                                                <Icon name={styleLocked ? "Lock" : "Unlock"} size={14}/> 樣式鎖定
                                            </label>
                                            <button onClick={() => setStyleLocked(!styleLocked)} className={`px-2 py-1 rounded-lg text-[10px] font-bold ${styleLocked ? "bg-white/10" : "bg-slate-900 text-white"}`}>
                                                {styleLocked ? "解鎖" : "鎖定"}
                                            </button>
                                        </div>
                                        <select disabled={styleLocked} value={selectedStyle.id} onChange={(e) => setSelectedStyle(STYLES.find(s => s.id === e.target.value))} className="w-full p-2 text-xs font-bold bg-slate-50 rounded-lg outline-none">
                                            {STYLES.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                        </select>
                                        {selectedStyle.id === 'custom' && (
                                            <textarea value={customStylePrompt} onChange={(e) => setCustomStylePrompt(e.target.value)} placeholder="自定義風格咒語..." className="w-full mt-3 p-2 text-[10px] rounded-lg border h-20 text-slate-800" />
                                        )}
                                    </div>

                                    {taskType === "POV" && (
                                        <div className="space-y-6">
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 mb-2 block uppercase">渲染區域</label>
                                                <select value={selectedRoom} onChange={(e) => setSelectedRoom(e.target.value)} className="w-full p-2.5 rounded-xl border text-xs font-bold outline-none">
                                                    {ROOMS.map(r => <option key={r} value={r}>{r}</option>)}
                                                </select>
                                                {selectedRoom === '自定義空間 (Custom)' && (
                                                    <input value={customRoomName} onChange={(e) => setCustomRoomName(e.target.value)} placeholder="例如：手術室..." className="w-full mt-2 p-2 text-xs border rounded-lg" />
                                                )}
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-xl">
                                                <button onClick={() => setEditMode("POV")} className={`py-2 rounded-lg text-xs font-bold ${editMode === "POV" ? "bg-white shadow-sm" : "text-slate-500"}`}>視角</button>
                                                <button onClick={() => setEditMode("ANCHOR")} className={`py-2 rounded-lg text-xs font-bold ${editMode === "ANCHOR" ? "bg-white shadow-sm" : "text-slate-500"}`}>錨點</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="lg:col-span-6 space-y-4">
                                <div className="bg-white p-5 rounded-[3.5rem] shadow-xl border border-white overflow-hidden relative group">
                                    <div className="absolute top-4 left-1/2 -translate-x-1/2 text-[12px] font-black text-slate-400 opacity-60 bg-white/50 px-2 rounded-full z-10">N</div>
                                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 text-[12px] font-black text-slate-400 opacity-60 bg-white/50 px-2 rounded-full z-10">S</div>
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-[12px] font-black text-slate-400 opacity-60 bg-white/50 px-2 rounded-full z-10">W</div>
                                    <div className="absolute right-4 top-1/2 -translate-y-1/2 text-[12px] font-black text-slate-400 opacity-60 bg-white/50 px-2 rounded-full z-10">E</div>

                                    <div ref={interactionRef} onMouseDown={handleCanvasInteraction} onMouseMove={handleMouseMove} onMouseUp={() => setIsDrawing(false)} onMouseLeave={() => setIsDrawing(false)} className={`relative w-full aspect-square bg-slate-100 rounded-[2.8rem] border border-slate-200 overflow-hidden ${image && taskType === 'POV' ? 'cursor-crosshair' : 'cursor-default'}`}>
                                        {image ? (
                                            <>
                                                <img src={image} className="w-full h-full object-contain select-none pointer-events-none opacity-95" />
                                                <svg className="absolute inset-0 w-full h-full pointer-events-none drop-shadow-2xl overflow-visible">
                                                    {arrow && taskType === "POV" && (
                                                        <g>
                                                            <path d={getViewConePath()} fill="rgba(79, 70, 229, 0.1)" stroke="rgba(79, 70, 229, 0.3)" strokeWidth="1" strokeDasharray="4,2" />
                                                            <line x1={`${arrow.start.x}%`} y1={`${arrow.start.y}%`} x2={`${arrow.end.x}%`} y2={`${arrow.end.y}%`} stroke="#4f46e5" strokeWidth="5" strokeLinecap="round" />
                                                            <circle cx={`${arrow.start.x}%`} cy={`${arrow.start.y}%`} r="10" fill="#4f46e5" stroke="white" strokeWidth="4" />
                                                        </g>
                                                    )}
                                                    {anchor && taskType === "POV" && (
                                                        <g transform={`translate(${anchor.x}, ${anchor.y})`}>
                                                            <circle cx="0" cy="0" r="10" fill="none" stroke="#f59e0b" strokeWidth="2" strokeDasharray="5,3" />
                                                            <polygon points="0,-10 3,-3 10,-3 4,2 6,10 0,5 -6,10 -4,2 -10,-3 -3,-3" fill="#f59e0b" stroke="#fff" strokeWidth="1" transform="scale(0.8)" />
                                                        </g>
                                                    )}
                                                </svg>
                                            </>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center h-full text-slate-300">上傳底圖開始作業</div>
                                        )}
                                    </div>
                                    <div className="absolute top-10 left-10 flex gap-2">
                                        <span className={`text-white text-[10px] font-black px-5 py-2.5 rounded-full uppercase tracking-widest ${taskType === 'TOPDOWN' ? 'bg-emerald-600' : 'bg-slate-900'}`}>{taskType} ACTIVE</span>
                                        {(arrow || anchor) && <button onClick={clearMarkers} className="bg-white text-rose-500 p-2 rounded-full shadow-lg">X</button>}
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-3 space-y-4">
                                <div className="bg-slate-900 p-8 rounded-[3rem] text-white shadow-2xl h-full flex flex-col">
                                    <div className="flex items-center justify-between mb-8 border-b border-white/10 pb-6">
                                        <h2 className="font-black text-[10px] uppercase tracking-[0.3em] text-indigo-400 flex items-center gap-2"><Icon name="Wand2" size={18}/> Firefly 指令</h2>
                                        <button onClick={copyToClipboard} className={`px-4 py-2 rounded-xl text-[10px] font-black ${copied ? 'bg-emerald-500' : 'bg-slate-800'} transition-all`}>{copied ? "已複製" : "COPY"}</button>
                                    </div>
                                    <div className="flex-grow bg-white/[0.03] rounded-3xl p-6 font-mono text-[10px] leading-relaxed text-slate-300 overflow-y-auto select-all">{prompt}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>